# Pip package developer instructions

Run the whole code by running:

```sh
./start.sh
```

## Tests

```sh
python -m pytest
```

Run a specific test:

```sh
 cd /home/a/git/git/hledger/hledger-preprocessor && python -m pytest test/e2e/test_gif_03_crop_receipt.py::test_gif_03_crop_receipt -v
 cd /home/a/git/git/hledger/hledger-preprocessor && python -m pytest test/e2e/test_gif_04_label_receipt.py::test_gif_04_label_receipt -v
 cd /home/a/git/git/hledger/hledger-preprocessor && python -m pytest test/e2e/test_gif_03_match_receipt.py::test_gif_03_match_receipt -v
 cd /home/a/git/git/hledger/hledger-preprocessor && python -m pytest test/e2e/test_gif_3_match_receipt_to_csv.py::test_gif_3_match_receipt_to_csv -v

```
## Gifs
```sh
for gif in gifs/*/output/*.gif; do   mp4="${gif%.gif}.mp4";   ffmpeg -y -i "$gif" -movflags faststart -pix_fmt yuv420p     -vf "scale=trunc(iw/2)
```
## Developer

```bash
conda env create --file environment.yml
conda activate hledger_preprocessor
sudo apt install rubygems  # For: markdownlint

pre-commit install
pre-commit autoupdate
pre-commit run --all
sudo snap install go --classic
go install github.com/charmbracelet/vhs@latest   # or brew install vhs
```

## Run ./start.sh on test env

```sh
python run_start_sh_test.py
python /home/a/git/git/hledger/hledger-preprocessor/debug_match_setup.py
```

which outputs an environment that can be run with (something it says like):

```sh
./start.sh --config /home/a/finance_test/config.yaml
```

## Publish pip package

Install the pip package locally with:

```bash
rm -r build
python -m build
pip install -e .
```

Upload the pip package to the world with:

```bash
rm -r build
python -m build
python3 -m twine upload dist/\*
```

## Sphinx documentation

To generate the documentation ensure the pip package is installed locally, such
that the documentation is able to import its Python files.

```bash
rm -r build
python -m build
pip install -e .
```

Then build the documentation with::

```sh
cd docs
pip install -r requirements.txt
make html
```

You can now see all your auto-generated Sphinx documentation in:
[docs/build/html/index.html](docs/build/html/index.html). This repository
auto-generates the Sphinx documentation for all your Python files using the
[/docs/source/conf.py](/docs/source/conf.py) file.

### Additional manual documentation

- The [docs/source/index.rst](docs/source/index.rst) is autogenerated and
  contains the main page and documentation file-structure.
- You can also add additional manual documentation in Markdown format as files in:

```
docs/source/manual_documenation/your_manual_documentation_filename.md
docs/source/manual_documenation/another_manual_documentation_filename.md
```

and then adding those filepaths into the `docs/source/manual.rst` file like:

```rst
Handwritten Documentation
=========================
.. toctree::
   :maxdepth: 2

   manual_documenation/your_manual_documentation_filename.md
   another_manual_documentation_filename.md
```

## TL;DR running this pip package directly, without hledger-flow import (FOR TESTING ONLY)

(Outdated)

1. Start by creating the relevant directory structure and adding the `.csv`
   files you got from your bank/place into them with:

```sh
clear && hledger_preprocessor \
--new \
--csv-filepath ~/Downloads/some_unprocessed.csv \
--start-path ~/finance/retry \
--account-holder swag \
--bank some_bank \
--account-type some_type
```

2. Check if your classification logic covers all your transactions with:

```sh
clear && hledger_preprocessor \
--csv-filepath ~/finance/import/swag/some_bank/some_type/1-in/2024/some_unprocessed.csv \
--start-path ~/finance \
--account-holder swag \
--bank some_bank \
--account-type some_type \
--pre-processed-output-dir=2-preprocessed
```

If your classification logic is complete, it is silent. Otherwise, it will say something like:

```txt
print("\n Please add a rule for expense/income (and run again):")
<some bank transaction>
```

If it does, go to file:
`src/hledger_preprocessor/classification/logic_based/private_logic.py` and add
that rule to the functions: `def private_debit_classification(` and
`def private_credit_classification(` depending on whether the transaction and
expense or income.

To see how to add rules, look at:
`def classify_debit(self, transaction: Transaction) -> str:` In essence you add
more `if dict_contains_string(..) then return <some category>` lines until all your
transactions are classified using your classification logic.

3. Go back to step 2 until your logic classifies all your transactions.
1. Generate the `.rules` file for `hledger-flow`:

```sh
clear && hledger_preprocessor \
--generate-rules \
--start-path ~/finance \
--account-holder swag \
--bank some_bank \
--account-type some_type
```

## Generate labels with hledger pre-processor

```sh
hledger_preprocessor --new --start-path ~/finance/finance_v3 --csv-filepath ~/finance/2024_and_2025_bank_statements.csv --account-holder account_holder --bank bank_name --account-type account_type --receipts-path /home/a/finance/a-t-0/receipt --dataset-path /home/a/finance/a-t-0/dataset0 --make-receipt-labels
```

## Categorisation yaml

This command lists all sorted private categories in `private_logic.py`:

```sh
grep -o 'return category_namespace\..*' yourfile \
  | sed 's/^[[:space:]]*//' \
  | sort
```

You can use that to quickly generate a complete `categories.yaml`

Convvert that output with:

```py
items = [
    "some_parent.some_child.some_grandchild",
    "some_parent.some_child.other_grandchild",
    "other_parent.third_child",
]

from collections import defaultdict

def tree():
    return defaultdict(tree)

root = tree()

for path in items:
    parts = path.split(".")
    cur = root
    for p in parts:
        cur = cur[p]

def dump(node, indent=0):
    pad = "  " * indent
    for k in sorted(node.keys()):
        if node[k]:
            print(f"{pad}{k}:")
            dump(node[k], indent + 1)
        else:
            print(f"{pad}{k}: {{}}")

dump(root)
```
